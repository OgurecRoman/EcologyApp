import * as dotenv from 'dotenv';
import { Bot, Keyboard } from '@maxhub/max-bot-api';
import { addSubscriber, removeSubscriber, sendNewEventNotification } from './notification.js';

dotenv.config();

const token = process.env.BOT_TOKEN;
if (!token) {
    console.error('âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: BOT_TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
    process.exit(1);
}

console.log('âœ… Ğ¢Ğ¾ĞºĞµĞ½ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½');
const bot = new Bot(token);

const ECOLOGY_API_URL = 'https://ecology-app.vercel.app/events';

const EVENT_TYPES = {
    SUBBOTNIK: 'ğŸŒ¿ Ğ¡ÑƒĞ±Ğ±Ğ¾Ñ‚Ğ½Ğ¸Ğº',
    PAPER_COLLECTION: 'ğŸ“„ Ğ¡Ğ±Ğ¾Ñ€ Ğ¼Ğ°ĞºÑƒĞ»Ğ°Ñ‚ÑƒÑ€Ñ‹',
    BATTERY_COLLECTION: 'ğŸ”‹ Ğ¡Ğ±Ğ¾Ñ€ Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµĞµĞº',
    PLASTIC_COLLECTION: 'ğŸ«™ Ğ¡Ğ±Ğ¾Ñ€ Ğ¿Ğ»Ğ°ÑÑ‚Ğ¸ĞºĞ°',
    MITTING: 'ğŸ¯ Ğ—Ğ°Ñ…Ğ²Ğ°Ñ‚ Ğ²Ğ»Ğ°ÑÑ‚Ğ¸',
    PLANTING_TREES: 'ğŸŒ³ Ğ’Ñ‹ÑĞ°Ğ´ĞºĞ° Ğ´ĞµÑ€ĞµĞ²ÑŒĞµĞ²',
    OTHER: 'â“ Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ'
};

// Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
let lastEvents = [];
let lastCheckTime = new Date();

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ñ API
async function getEventsFromAPI() {
    try {
        console.log('ğŸ“¡ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ñ:', ECOLOGY_API_URL);

        const response = await fetch(ECOLOGY_API_URL, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const events = await response.json();
        console.log(`âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ${events.length} ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹`);
        return events;
    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:', error);
        throw error;
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
async function checkForNewEvents() {
    try {
        console.log('ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹...');

        const currentEvents = await getEventsFromAPI();

        if (lastEvents.length === 0) {
            // ĞŸĞµÑ€Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
            lastEvents = currentEvents;
            console.log('ğŸ“ ĞŸĞµÑ€Ğ²Ğ¾Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹');
            return [];
        }

        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ñ‚Ğµ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ² Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ)
        const newEvents = currentEvents.filter(currentEvent =>
            !lastEvents.some(lastEvent =>
                lastEvent.id === currentEvent.id ||
                (lastEvent.name === currentEvent.name &&
                    lastEvent.date === currentEvent.date)
            )
        );

        console.log(`ğŸ†• ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹: ${newEvents.length}`);

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ
        lastEvents = currentEvents;
        lastCheckTime = new Date();

        return newEvents;
    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:', error);
        return [];
    }
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ…
async function notifyAboutNewEvents() {
    try {
        const newEvents = await checkForNewEvents();

        if (newEvents.length === 0) {
            console.log('â„¹ï¸ ĞĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ½ĞµÑ‚');
            return;
        }

        console.log(`ğŸ“¢ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${newEvents.length} Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ`);

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
        for (const event of newEvents) {
            console.log(`ğŸ“¨ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸: "${event.name}"`);
            await sendNewEventNotification(event);

            // ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ¿Ğ°ÑƒĞ·Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°Ğ¼Ğ¸
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ…:', error);
    }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
function startEventMonitoring() {
    const CHECK_INTERVAL = 2 * 60 * 1000; // 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹

    console.log(`ğŸ• Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»: ${CHECK_INTERVAL/1000} ÑĞµĞºÑƒĞ½Ğ´)`);

    // ĞŸĞµÑ€Ğ²Ğ¾Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    getEventsFromAPI().then(events => {
        lastEvents = events;
        console.log(`ğŸ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ ${events.length} ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°`);
    });

    // ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
    setInterval(notifyAboutNewEvents, CHECK_INTERVAL);

    // Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ñ
    setInterval(notifyAboutNewEvents, 60 * 1000);
}

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
bot.command('check_new', async (ctx) => {
    try {
        await ctx.reply('ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ...');

        const newEvents = await checkForNewEvents();

        if (newEvents.length === 0) {
            await ctx.reply('â„¹ï¸ ĞĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾');
        } else {
            await ctx.reply(`ğŸ‰ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${newEvents.length} Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹! Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ...`);

            for (const event of newEvents) {
                await sendNewEventNotification(event);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ:', error);
        await ctx.reply('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹');
    }
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
bot.command('monitor_status', async (ctx) => {
    const statusMessage = `ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹**\n\n` +
        `ğŸ” ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: ${lastCheckTime.toLocaleString('ru-RU')}\n` +
        `ğŸ“ ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹: ${lastEvents.length}\n` +
        `ğŸ‘¥ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²: ${getSubscribersCount()}\n\n` +
        `_Ğ‘Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 1-2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹_`;

    await ctx.reply(statusMessage);
});

function getSubscribersCount() {
    return 0; // Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°
}

bot.command('test_notify', async (ctx) => {
    try {
        const testEvent = {
            name: "Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ",
            description: "Ğ­Ñ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ±Ğ¾Ñ‚Ğ°",
            type: "SUBBOTNIK",
            date: new Date().toISOString(),
            address: "Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ",
            author: "Ğ‘Ğ¾Ñ‚"
        };

        const results = await sendNewEventNotification(testEvent);
        ctx.reply(`âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾! Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾: ${results.filter(r => r.status === 'success').length}`);
    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:', error);
        ctx.reply('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ');
    }
});

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ñ‚Ñ‹
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ñ‚Ñ‹:', dateString);
        return dateString;
    }
}

bot.command('start', (ctx) => {
    const chatId = ctx.update.message?.recipient?.chat_id;
    const userName = ctx.update.message?.from?.first_name || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';

    addSubscriber(chatId, ctx);

    const keyboard = Keyboard.inlineKeyboard([
        [
            Keyboard.button.link('ğŸ“… Ğ—Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ', 'https://ecology-app.vercel.app')
        ]
    ]);

    ctx.reply(
        `ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ${userName}! ğŸ‘‹\n\n` +
        `Ğ¯ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ½Ğ°ÑˆÑƒ Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚Ñƒ Ñ‡ÑƒÑ‚Ğ¾Ñ‡ĞºÑƒ Ğ»ÑƒÑ‡ÑˆĞµ! ğŸŒ\n\n` +
        `Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ñ Ğ±ÑƒĞ´Ñƒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ñ‚ĞµĞ±Ñ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ…! ğŸ“¢\n\n` +
        `Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n` +
        `/events - ğŸ“… ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²ÑĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ\n` +
        `/unsubscribe - ğŸ”• ĞÑ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ¾Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹\n` +
        `/monitor_status - ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°\n` +
        `/help - â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼\n\n` +
        `Ğ˜Ğ»Ğ¸ Ñ‚Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ Ğ¼ĞµÑ€Ğ¾Ğ¿Ñ€Ğ¸ÑÑ‚Ğ¸Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ! :0`,
        {
            attachments: [keyboard]
        }
    );
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ğ¸ÑĞºĞ¸ Ğ¾Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
bot.command('unsubscribe', (ctx) => {
    const chatId = ctx.update.message?.recipient?.chat_id;
    const userName = ctx.update.message?.from?.first_name || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';

    const removed = removeSubscriber(chatId);

    if (removed) {
        ctx.reply(
            `ğŸ”• ${userName}, Ğ½Ñƒ Ğ¸ Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°(.\n\n` +
            `ĞĞ¾ ĞµÑĞ»Ğ¸ Ğ²Ğ´Ñ€ÑƒĞ³ Ğ¿ĞµÑ€ĞµĞ´ÑƒĞ¼Ğ°ĞµÑˆÑŒ, Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ‚Ñ‹Ğº Ğ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start`
        );
    } else {
        ctx.reply(
            `â„¹ï¸ ${userName}, Ñ‚Ğ°Ğº Ñ‚Ñ‹ Ğ¸ Ğ½Ğµ Ğ±Ñ‹Ğ» Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ Ğ½Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ)\n\n` +
            `Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ, Ñ‚Ñ‹Ğº Ğ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /start`
        );
    }
});

bot.command('help', (ctx) => {
    const keyboard = Keyboard.inlineKeyboard([
        [
            Keyboard.button.link('ğŸŒ Ğ¢Ñ‹Ğº ÑÑĞ´Ğ°', 'https://ecology-app.vercel.app')
        ]
    ]);

    ctx.reply(
        `ğŸ“‹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n\n` +
        `/start - ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ\n` +
        `/unsubscribe - ĞÑ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ¾Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹\n` +
        `/events - ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²ÑĞµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ\n` +
        `/monitor_status - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹\n` +
        `/check_new - ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ\n` +
        `/help - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ\n\n` +
        `ğŸ”” ĞŸĞ¾ÑĞ»Ğµ /start Ğ²Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ…!\n\n` +
        `ğŸŒ± Ğ‘Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 1-2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸!`,
        {
            attachments: [keyboard]
        }
    );
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
bot.command('events', async (ctx) => {
    try {
        console.log('ğŸ”„ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ');

        const loadingMessage = await ctx.reply('ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ...');

        const events = await getEventsFromAPI();

        const keyboard = Keyboard.inlineKeyboard([
            [
                Keyboard.button.link('ğŸ“… Ğ—Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ñ‘ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ', 'https://ecology-app.vercel.app')
            ]
        ]);

        if (events.length === 0) {
            await ctx.reply(
                'ĞŸĞ¾ĞºĞ° Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ½ĞµÑ‚ :9(\n\n' +
                'ĞĞ¾ Ñ‚Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ ÑÑ‚Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼!',
                {
                    attachments: [keyboard]
                }
            );
            return;
        }

        let message = `ğŸ“… ĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (${events.length}):\n\n`;

        events.forEach((event, index) => {
            const eventType = EVENT_TYPES[event.type] || event.type;
            const eventDate = formatDate(event.date);

            message += `${index + 1}. ${event.name}\n` +
                `ğŸ“ ${event.description}\n` +
                `ğŸ·ï¸ ${eventType}\n` +
                `ğŸ“… ${eventDate}\n` +
                `ğŸ“ ${event.address}\n` +
                `ğŸ‘¤ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€: ${event.author}\n`;

            if (index < events.length - 1) {
                message += '\n' + 'â”€'.repeat(15) + '\n\n';
            }
        });

        message += `\nğŸ¯ Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ñ‘ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ?`;

        await ctx.reply(message, {
            attachments: [keyboard]
        });

    } catch (error) {
        console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:', error);

        const keyboard = Keyboard.inlineKeyboard([
            [
                Keyboard.button.link('Ğ¢Ñ‹Ğº Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿Ğ¾Ñ‡ĞºÑƒ', 'https://ecology-app.vercel.app')
            ]
        ]);

        await ctx.reply(
            'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ.\n\n' +
            'Ğ£ Ğ½Ğ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑˆĞ¾ĞºĞ¾Ğ»Ğ°Ğ´ĞºĞ¸, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ·Ğ¶Ğµ',
            {
                attachments: [keyboard]
            }
        );
    }
});

bot.on('message_created', (ctx) => {
    const text = ctx.update.message?.body?.text;
    const userName = ctx.update.message?.from?.first_name || 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';

    if (text && text.startsWith('/')) {
        return;
    }

    const keyboard = Keyboard.inlineKeyboard([
        [
            Keyboard.button.link('ğŸ“… Ğ—Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ', 'https://ecology-app.vercel.app')
        ]
    ]);

    ctx.reply(
        `ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ${userName}! ğŸ‘‹\n\n` +
        `Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ?\n\n` +
        `Ğ¢Ñ‹Ğº Ğ½Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /events Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ²ÑĞµ Ğ¼ĞµÑ€Ğ¾Ğ¿Ñ€Ğ¸ÑÑ‚Ğ¸Ñ!\n\n` +
        `Ğ˜Ğ»Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ñ‚Ñ‹ĞºĞ½ÑƒÑ‚ÑŒ Ğ½Ñƒ ĞºĞ½Ğ¾Ğ¿Ğ¾Ñ‡ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ!`,
        {
            attachments: [keyboard]
        }
    );
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
bot.on('error', (error) => {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ±Ğ¾Ñ‚Ğ°:', error);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°
console.log('ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Ecology App...');
console.log(`ğŸŒ API Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: ${ECOLOGY_API_URL}`);

bot.start().then(() => {
    console.log('âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');
    console.log('ğŸ“¡ Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ API');
    console.log('ğŸ”” Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°');
    console.log('ğŸ‘ï¸  Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹');
    console.log('ğŸ’¬ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:');
    console.log('   â€¢ /start - Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ');
    console.log('   â€¢ /events - Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ');
    console.log('   â€¢ /unsubscribe - Ğ¾Ñ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ¾Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹');
    console.log('   â€¢ /monitor_status - ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°');
    console.log('   â€¢ /check_new - Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°');
    console.log('   â€¢ /help - Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ');

    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ğ° Ğ±Ğ¾Ñ‚Ğ°
    startEventMonitoring();
}).catch(error => {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°:', error);
});

