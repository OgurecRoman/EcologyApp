<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞—Ä—Ç–∞ —Å–æ–±—ã—Ç–∏–π</title>
<script src="https://api-maps.yandex.ru/2.1/?apikey=aa41fd1c-f570-4490-9b73-ae3db02fa604&lang=ru_RU" type="text/javascript"></script>
<script src="https://st.max.ru/js/max-web-app.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
#map { width: 100%; height: 500px; margin-bottom: 20px; }
#search { width: 300px; margin: 10px; padding: 5px; }
form { margin: 20px auto; width: 400px; text-align: left; }
form input, form select, form textarea, form button { width: 100%; margin-bottom: 10px; padding: 5px; }
form button { cursor: pointer; }
</style>
</head>
<body>
<h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h1>

<input id="search" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ" />

<div id="map"></div>

<h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
<form id="eventForm">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
    <input type="text" id="name" required />
    
    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
    <textarea id="description" required></textarea>
    
    <label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>
    <select id="type" required>
        <option value="SUBBOTNIK">–°—É–±–±–æ—Ç–Ω–∏–∫</option>
        <option value="PAPER_COLLECTION">–°–±–æ—Ä –±—É–º–∞–≥–∏</option>
        <option value="BATTERY_COLLECTION">–°–±–æ—Ä –±–∞—Ç–∞—Ä–µ–µ–∫</option>
        <option value="PLASTIC_COLLECTION">–°–±–æ—Ä –ø–ª–∞—Å—Ç–∏–∫–∞</option>
        <option value="GLASS_COLLECTION">–°–±–æ—Ä —Å—Ç–µ–∫–ª–∞</option>
        <option value="ELECTRONICS_COLLECTION">–°–±–æ—Ä —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</option>
        <option value="OTHER">–î—Ä—É–≥–æ–µ</option>
    </select>
    
    <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
    <input type="datetime-local" id="date" required />
    
    <label>–ê–¥—Ä–µ—Å:</label>
    <input type="text" id="address" required />
    
    <label>–ê–≤—Ç–æ—Ä:</label>
    <input type="text" id="author" required />
    
    <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
    <input type="text" id="participants" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1,2,3" />
    
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
</form>

<script>
console.log(Window.WebApp.initData);
ymaps.ready(init);

let myMap;
let myPlacemark;
let eventPlacemarks = [];

async function fetchEvents() {
    try {
        const response = await fetch('/events');
        return await response.json();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–±—ã—Ç–∏–π', err);
        return [];
    }
}

function init() {
    myMap = new ymaps.Map('map', {
        center: [55.751244, 37.618423],
        zoom: 10
    });

    const searchInput = document.getElementById('search');

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = searchInput.value;
            ymaps.geocode(query, { results: 1 }).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                const coords = firstGeoObject.geometry.getCoordinates();

                myMap.setCenter(coords, 14, { duration: 500 });

                if (myPlacemark) {
                    myMap.geoObjects.remove(myPlacemark);
                }
                myPlacemark = new ymaps.Placemark(coords, {
                    balloonContent: firstGeoObject.getAddressLine()
                });
                myMap.geoObjects.add(myPlacemark);
            });
        }
    });

    loadEventMarkers();
}

async function loadEventMarkers() {
    const events = await fetchEvents();
    eventPlacemarks.forEach(p => myMap.geoObjects.remove(p));
    eventPlacemarks = [];

    events.forEach(event => {
        if (!event.address) return;

        ymaps.geocode(event.address).then(res => {
            const geoObject = res.geoObjects.get(0);
            if (!geoObject) return;

            const coords = geoObject.geometry.getCoordinates();
            const placemark = new ymaps.Placemark(coords, {
                balloonContentHeader: event.name,
                balloonContentBody:
                    "<strong>–î–∞—Ç–∞:</strong> " + new Date(event.date).toLocaleString('ru-RU') +
                    "<br><strong>–ê–¥—Ä–µ—Å:</strong> " + event.address +
                    "<br><strong>–ê–≤—Ç–æ—Ä:</strong> " + event.author +
                    "<br><strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</strong> " + (event.participants.map(p => p.name).join(', ') || '–ù–µ—Ç')
            });
            myMap.geoObjects.add(placemark);
            eventPlacemarks.push(placemark);
        });
    });
}

// –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
document.getElementById('eventForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const participantIds = document.getElementById('participants').value
        .split(',')
        .map(id => parseInt(id.trim()))
        .filter(id => !isNaN(id));

    const eventData = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        type: document.getElementById('type').value,
        date: document.getElementById('date').value,
        address: document.getElementById('address').value,
        author: document.getElementById('author').value,
        participantIds: participantIds
    };

    try {
        const res = await fetch('/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        });
        const newEvent = await res.json();
        alert('–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ' + newEvent.name);

        loadEventMarkers();
        document.getElementById('eventForm').reset();
    } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è');
    }
});
</script>
</body>
</html>