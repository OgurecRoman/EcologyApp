<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ —Å–æ–±—ã—Ç–∏–π</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=aa41fd1c-f570-4490-9b73-ae3db02fa604&lang=ru_RU" type="text/javascript"></script>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
        #map { width: 100%; height: 500px; margin-bottom: 20px; }
        form { margin: 20px auto; width: 400px; text-align: left; }
        form input, form select, form textarea, form button { width: 100%; margin-bottom: 10px; padding: 5px; }
        form button { cursor: pointer; }
        #filters { margin: 20px auto; width: 450px; text-align: left; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .checkbox-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .checkbox-list label { font-weight: normal; display: flex; align-items: center; gap: 5px; }
        .filter-buttons { display: flex; gap: 10px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
        .tabs { display: flex; justify-content: center; margin: 20px 0; }
        .tab-button { padding: 10px 20px; background: #eee; border: 1px solid #ccc; cursor: pointer; margin: 0 5px; border-radius: 6px 6px 0 0; }
        .tab-button.active { background: #fff; border-bottom: none; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
<h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ —Å–æ–±—ã—Ç–∏–π </h1>

<div class="tabs">
    <button class="tab-button active" data-tab="map-tab">–ö–∞—Ä—Ç–∞</button>
    <button class="tab-button" data-tab="add-tab">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
</div>

<!-- –í–ö–õ–ê–î–ö–ê –ö–ê–†–¢–´ -->
<div id="map-tab" class="tab-content active">
    <div id="map"></div>

    <div id="filters">
        <h2>–§–∏–ª—å—Ç—Ä—ã</h2>

        <div class="filter-group">
            <label for="filterCity">–ì–æ—Ä–æ–¥:</label>
            <input type="text" id="filterCity" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" />
        </div>

        <div class="filter-group">
            <label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ):</label>
            <div class="checkbox-list" id="typeCheckboxes">
                <label><input type="checkbox" value="SUBBOTNIK"> –°—É–±–±–æ—Ç–Ω–∏–∫</label>
                <label><input type="checkbox" value="PAPER_COLLECTION"> –°–±–æ—Ä –±—É–º–∞–≥–∏</label>
                <label><input type="checkbox" value="BATTERY_COLLECTION"> –°–±–æ—Ä –±–∞—Ç–∞—Ä–µ–µ–∫</label>
                <label><input type="checkbox" value="PLASTIC_COLLECTION"> –°–±–æ—Ä –ø–ª–∞—Å—Ç–∏–∫–∞</label>
                <label><input type="checkbox" value="GLASS_COLLECTION"> –°–±–æ—Ä —Å—Ç–µ–∫–ª–∞</label>
                <label><input type="checkbox" value="ELECTRONICS_COLLECTION"> –°–±–æ—Ä —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</label>
                <label><input type="checkbox" value="OTHER"> –î—Ä—É–≥–æ–µ</label>
            </div>
        </div>

        <div class="filter-buttons">
            <button id="applyFilter">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <button id="clearFilter">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –í–ö–õ–ê–î–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
<div id="add-tab" class="tab-content">
    <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
    <form id="eventForm">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input type="text" id="name" required />

        <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <textarea id="description" required></textarea>

        <label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>
        <select id="type" required>
            <option value="SUBBOTNIK">–°—É–±–±–æ—Ç–Ω–∏–∫</option>
            <option value="PAPER_COLLECTION">–°–±–æ—Ä –±—É–º–∞–≥–∏</option>
            <option value="BATTERY_COLLECTION">–°–±–æ—Ä –±–∞—Ç–∞—Ä–µ–µ–∫</option>
            <option value="PLASTIC_COLLECTION">–°–±–æ—Ä –ø–ª–∞—Å—Ç–∏–∫–∞</option>
            <option value="GLASS_COLLECTION">–°–±–æ—Ä —Å—Ç–µ–∫–ª–∞</option>
            <option value="ELECTRONICS_COLLECTION">–°–±–æ—Ä —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏</option>
            <option value="OTHER">–î—Ä—É–≥–æ–µ</option>
        </select>

        <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</label>
        <input type="datetime-local" id="date" required />

        <label>–ê–¥—Ä–µ—Å:</label>
        <input type="text" id="address" required />

        <label>–ì–æ—Ä–æ–¥:</label>
        <input type="text" id="city" required />

        <label>–ê–≤—Ç–æ—Ä:</label>
        <input type="text" id="author" required />

        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
    </form>
</div>

<script>
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
    async function fetchUser(id, name) {
        try {
            const queryParams = new URLSearchParams({ id, name });
            const url = `/user?${queryParams.toString()}`;
            const response = await fetch(url);
            return await response.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', err);
            return { username: '–ê–Ω–æ–Ω–∏–º' };
        }
    }

    async function initWebApp() {
        if (window.WebApp) {
            try {
                const data = window.WebApp.initDataUnsafe;
                document.getElementById('id').textContent = `${data.user.id} ${data.user.first_name}`;
                const user = await fetchUser(data.user.id, data.user.first_name);
                document.getElementById('user').textContent = user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            } catch (err) {
                console.error('WebApp init error:', err);
            }
        }
    }
    document.addEventListener('DOMContentLoaded', initWebApp);

    // --- –ö–ê–†–¢–ê ---
    ymaps.ready(init);
    let myMap, userCity = '–ú–æ—Å–∫–≤–∞', currentGeneration = 0, eventPlacemarks = [];

    async function fetchEvents(city = '', types = []) {
        try {
            const params = new URLSearchParams();
            if (city) params.append('city', city);
            if (types.length > 0) params.append('types', types.join(','));
            const url = params.toString() ? `/events?${params.toString()}` : '/events';
            console.log('–ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É:', url);
            const response = await fetch(url);
            return await response.json();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
            return [];
        }
    }

    function init() {
        myMap = new ymaps.Map('map', { center: [55.751244, 37.618423], zoom: 10 });

        ymaps.geolocation.get({ provider: 'browser' })
            .then(async result => {
                const position = result.position;
                myMap.setCenter(position, 10);
                const res = await ymaps.geocode(position);
                const detectedCity = res.geoObjects.get(0).getLocalities()[0] || '–ú–æ—Å–∫–≤–∞';

                if (confirm(`–í–∞—à –≥–æ—Ä–æ–¥ ‚Äî ${detectedCity}?`)) {
                    userCity = detectedCity;
                } else {
                    userCity = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:', detectedCity) || '–ú–æ—Å–∫–≤–∞';
                    const centerRes = await ymaps.geocode(userCity);
                    const coords = centerRes.geoObjects.get(0).geometry.getCoordinates();
                    myMap.setCenter(coords, 10);
                }

                document.getElementById('filterCity').value = userCity;
                loadEventMarkers(userCity);
            })
            .catch(() => {
                userCity = '–ú–æ—Å–∫–≤–∞';
                document.getElementById('filterCity').value = userCity;
                loadEventMarkers(userCity);
            });

        // --- –§–ò–õ–¨–¢–†–´ ---
        document.getElementById('applyFilter').addEventListener('click', async () => {
            const filterCity = document.getElementById('filterCity').value.trim();
            const checked = document.querySelectorAll('#typeCheckboxes input:checked');
            const filterTypes = Array.from(checked).map(cb => cb.value);

            if (filterCity && filterCity !== userCity) {
                try {
                    const res = await ymaps.geocode(filterCity);
                    const coords = res.geoObjects.get(0).geometry.getCoordinates();
                    myMap.setCenter(coords, 10);
                    userCity = filterCity;
                } catch (err) {
                    alert('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ.');
                }
            }

            loadEventMarkers(filterCity, filterTypes);
        });

        document.getElementById('clearFilter').addEventListener('click', () => {
            document.getElementById('filterCity').value = userCity;
            document.querySelectorAll('#typeCheckboxes input').forEach(cb => cb.checked = false);
            loadEventMarkers(userCity, []);
        });
    }

    async function loadEventMarkers(city = '', types = []) {
        currentGeneration++;
        const gen = currentGeneration;

        const events = await fetchEvents(city, types);
        console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', events);

        myMap.geoObjects.removeAll();
        eventPlacemarks = [];

        const promises = events.map(event => {
            if (!event.address) return Promise.resolve();
            return ymaps.geocode(event.address).then(res => {
                if (gen !== currentGeneration) return;
                const geoObject = res.geoObjects.get(0);
                if (!geoObject) return;
                const coords = geoObject.geometry.getCoordinates();
                const placemark = new ymaps.Placemark(coords, {
                    balloonContentHeader: event.name,
                    balloonContentBody: `
                        <strong>–î–∞—Ç–∞:</strong> ${new Date(event.date).toLocaleString('ru-RU')}<br>
                        <strong>–ê–¥—Ä–µ—Å:</strong> ${event.address}<br>
                        <strong>–ê–≤—Ç–æ—Ä:</strong> ${event.author}<br>
                    `
                });
                myMap.geoObjects.add(placemark);
                eventPlacemarks.push(placemark);
            });
        });

        await Promise.all(promises);
    }

    // --- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
    document.getElementById('eventForm').addEventListener('submit', async e => {
        e.preventDefault();

        const eventData = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            type: document.getElementById('type').value,
            date: document.getElementById('date').value,
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            author: document.getElementById('author').value,
            participantIds
        };

        try {
            const res = await fetch('/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
            });

            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            const newEvent = await res.json();
            alert(`–°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ${newEvent.name}`);

            const checked = document.querySelectorAll('#typeCheckboxes input:checked');
            const filterTypes = Array.from(checked).map(cb => cb.value);
            loadEventMarkers(userCity, filterTypes);
            document.getElementById('eventForm').reset();
            switchTab('map-tab');
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è');
        }
    });

    // --- –í–ö–õ–ê–î–ö–ò ---
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    function switchTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }
</script>
</body>
</html>